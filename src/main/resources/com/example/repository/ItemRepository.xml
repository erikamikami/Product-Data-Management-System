<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.repository.ItemRepository">

<select id="countAllItems" resultType="int">
  SELECT count(*) FROM items;
</select>

<select id="findAll" resultType="com.example.entity.Item" parameterType="com.example.pagination.Pagination">
  SELECT id, name, condition, category, brand_name, price, shipping, item_description
  FROM items
  ORDER BY id ASC
  LIMIT #{displaysPerPage} OFFSET #{displaysPerPage}*(#{page}-1)
</select>

<select id="findById" resultType="com.example.entity.Item" parameterType="int">
  SELECT id, name, condition, category, brand_name, price, shipping, item_description
  FROM items
  WHERE id = #{id}
</select>

<select id="findMaxId" resultType="int">
  SELECT max(id) FROM items;
</select>

<insert id="insert" parameterType="com.example.entity.Item">
  INSERT INTO items (id, name, condition, category, brand_name, price, shipping, item_description)
  VALUES (#{id}, #{name}, #{condition}, #{category}, #{brandName}, #{price}, #{shipping}, #{itemDescription})
</insert>

<update id="update" parameterType="com.example.entity.Item">
  UPDATE items SET 
  name = #{name}
  ,condition = #{condition}
  ,category = #{category}
  ,brand_name = #{brandName}
  ,price = #{price}
  ,shipping = #{shipping}
  ,item_description = #{itemDescription}
  WHERE id = #{id}
</update>

<select id="search" parameterType="com.example.form.ItemSearchForm" resultType="com.example.entity.Item">
  SELECT id, name, condition, category, brand_name, price, shipping, item_description
  FROM items
  WHERE 1 = 1
  
  <choose>
    <when test="parentCategory != null and childCategory != null and grandChild != null "> <!-- 親・子・孫 -->
      AND category = #{parentCategory} || '/' || #{childCategory} || '/' || #{grandChild}
    </when>
    <when test="parentCategory != null and childCategory != null and grandChild == null"> <!-- 親・子 -->
      AND category LIKE '%' || #{parentCategory} || '/' || #{childCategory}
    </when>
    <when test="parentCategory != null and childCategory == null and grandChild != null"> <!-- 親・孫 -->
      AND category LIKE #{parentCategory} || '%'
      AND category LIKE '%' || #{grandChild} 
    </when>
    <when test="parentCategory == null and childCategory != null and grandChild != null"> <!-- 子・孫 -->
      AND category LIKE '%' || #{childCategory} || '/' || #{grandChild}
    </when>
    <when test="parentCategory != null and childCategory == null and grandChild == null "> <!-- 親 -->
      AND category LIKE #{parentCategory} || '%'
    </when>
    <when test="parentCategory == null and childCategory != null and grandChild == null "> <!-- 子 -->
      AND category LIKE '%' || '/' || #{childCategory} || '/' || '%'
    </when>
    <when test="parentCategory == null and childCategory == null and grandChild != null "> <!-- 孫 -->
      AND category LIKE '%' || #{grandChild}
    </when>
    <otherwise>
      AND 1 = 1
    </otherwise>
  </choose>
  
  <if test="name != null">
    AND name LIKE '%' || #{name} || '%'
  </if>
  
  <if test="brandName != null">
    AND brand_name LIKE '%' || #{brandName} || '%'
  </if>
  
</select>

</mapper>
